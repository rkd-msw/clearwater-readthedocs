<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Stress Testing &mdash; Project Clearwater 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Project Clearwater 1.0 documentation" href="index.html" />
    <link rel="next" title="Using Cacti with Clearwater" href="Cacti.html" />
    <link rel="prev" title="Pull Request Process" href="Pull_request_process.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="stress-testing">
<h1>Stress Testing<a class="headerlink" href="#stress-testing" title="Permalink to this headline">¶</a></h1>
<p>One of Clearwater&#8217;s biggest strengths is scalability and in order to
demonstrate this, we have easy-to-use settings for running large amounts
of SIP stress against a deployment. This document describes: -
Clearwater&#8217;s SIP stress nodes, what they do, and (briefly) how they work
- how to kick off your own stress test.</p>
<div class="section" id="sip-stress-nodes">
<h2>SIP Stress Nodes<a class="headerlink" href="#sip-stress-nodes" title="Permalink to this headline">¶</a></h2>
<p>A Clearwater SIP stress node is similar to any other Project Clearwater
node, except that instead of having a Debian package like <code class="docutils literal"><span class="pre">bono</span></code> or
<code class="docutils literal"><span class="pre">sprout</span></code> installed, it has our <code class="docutils literal"><span class="pre">clearwater-sip-stress</span></code> Debian
package installed.</p>
<div class="section" id="what-they-do">
<h3>What they do<a class="headerlink" href="#what-they-do" title="Permalink to this headline">¶</a></h3>
<p>Clearwater SIP stress nodes run a standard SIPp script against your bono
cluster. The bono nodes translate this into traffic for sprout and this
generates traffic on homestead and homer. The nodes log their
success/failure to <code class="docutils literal"><span class="pre">/var/log/clearwater-sip-stress</span></code> and also restart
SIPp (after a 30s cool-down) if anything goes wrong.</p>
<p>The SIPp stress starts as soon as the node comes up - this is by design,
to avoid you having to manually start 50+ nodes generating traffic. If
you want to stop them from generating traffic, turn the whole node down.</p>
<p>Each SIP stress node picks a single bono to generate traffic against.
This bono is chosen by matching the bono node&#8217;s index against the SIP
stress node&#8217;s index. As a result, it&#8217;s important to always give SIP
stress nodes an index.</p>
</div>
<div class="section" id="how-they-work">
<h3>How they work<a class="headerlink" href="#how-they-work" title="Permalink to this headline">¶</a></h3>
<p>The clearwater-sip-stress package includes two important scripts.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/usr/share/clearwater/infrastructure/scripts/sip-stress</span></code>, which
generates a <code class="docutils literal"><span class="pre">/usr/share/clearwater/sip-stress/users.csv.1</span></code> file
containing the list of all subscribers we should be targeting - these
are calculated from properties in <code class="docutils literal"><span class="pre">/etc/clearwater/shared_config</span></code>.</li>
<li><code class="docutils literal"><span class="pre">/etc/init.d/clearwater-sip-stress</span></code>, which runs
<code class="docutils literal"><span class="pre">/usr/share/clearwater/bin/sip-stress</span></code>, which in turn runs SIPp
specifying <code class="docutils literal"><span class="pre">/usr/share/clearwater/sip-stress/call_load2.xml</span></code> as its
test script. This test script simulates a pair of subscribers
registering every 5 minutes and then making a call every 30 minutes.</li>
</ul>
<p>The stress test logs to
<code class="docutils literal"><span class="pre">/var/log/clearwater-sip-stress/sipp.&lt;index&gt;.out</span></code>.</p>
</div>
</div>
<div class="section" id="running-stress">
<h2>Running Stress<a class="headerlink" href="#running-stress" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-chef">
<h3>Using Chef<a class="headerlink" href="#using-chef" title="Permalink to this headline">¶</a></h3>
<p>This section describes step-by-step how to run stress using Chef
automation. It includes setting up a new deployment. It is possible to
run stress against an existing deployment but you&#8217;ll need to reconfigure
some things so it&#8217;s easier just to tear down your existing deployment
and start again.</p>
<ol class="arabic">
<li><p class="first">If you haven&#8217;t done so already, set up chef/knife (as described in
<a class="reference external" href="Automated_Install.md">the install guide</a>).</p>
</li>
<li><p class="first">cd to your chef directory.</p>
</li>
<li><p class="first">Edit your environment (e.g. <code class="docutils literal"><span class="pre">environments/ENVIRONMENT.rb</span></code>) to
override attributes as follows.</p>
<p>For example (replacing ENVIRONMENT with your environment name and
DOMAIN with your Route 53-hosted root domain):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>name &quot;ENVIRONMENT&quot;
description &quot;Stress testing environment&quot;
cookbook_versions &quot;clearwater&quot; =&gt; &quot;= 0.1.0&quot;
override_attributes &quot;clearwater&quot; =&gt; {
    &quot;root_domain&quot; =&gt; &quot;DOMAIN&quot;,
    &quot;availability_zones&quot; =&gt; [&quot;us-east-1a&quot;],
    &quot;repo_server&quot; =&gt; &quot;http://repo.cw-ngv.com/latest&quot;,
    &quot;number_start&quot; =&gt; &quot;2010000000&quot;,
    &quot;number_count&quot; =&gt; 1000,
    &quot;pstn_number_count&quot; =&gt; 0}
</pre></div>
</div>
</li>
<li><p class="first">Upload your new environment to the chef server by typing
<code class="docutils literal"><span class="pre">knife</span> <span class="pre">environment</span> <span class="pre">from</span> <span class="pre">file</span> <span class="pre">environments/ENVIRONMENT.rb</span></code></p>
</li>
<li><p class="first">Create the deployment by typing
<code class="docutils literal"><span class="pre">knife</span> <span class="pre">deployment</span> <span class="pre">resize</span> <span class="pre">-E</span> <span class="pre">ENVIRONMENT</span></code>. If you want more nodes,
supply parameters such &#8220;&#8211;bono-count 5&#8221; or &#8220;&#8211;sprout-count 3&#8221; to
control this.</p>
</li>
<li><p class="first">Follow <a class="reference external" href="https://github.com/Metaswitch/crest/blob/dev/docs/Bulk-Provisioning%20Numbers.md">this
process</a>
to bulk provision subscribers. Create 30000 subscribers per SIPp
node.</p>
</li>
<li><p class="first">Create your stress test node by typing
<code class="docutils literal"><span class="pre">knife</span> <span class="pre">box</span> <span class="pre">create</span> <span class="pre">-E</span> <span class="pre">ENVIRONMENT</span> <span class="pre">sipp</span> <span class="pre">--index</span> <span class="pre">1</span></code>. If you have
multiple bono nodes, you&#8217;ll need to create multiple stress test nodes
by repeating this command with &#8220;&#8211;index 2&#8221;, &#8220;&#8211;index 3&#8221;, etc. - each
stress test node only sends traffic to the bono with the same index.</p>
</li>
</ol>
<ul class="simple">
<li>To create multiple nodes, try
<code class="docutils literal"><span class="pre">for</span> <span class="pre">x</span> <span class="pre">in</span> <span class="pre">{1..20}</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">{</span> <span class="pre">knife</span> <span class="pre">box</span> <span class="pre">create</span> <span class="pre">-E</span> <span class="pre">ENVIRONMENT</span> <span class="pre">sipp</span> <span class="pre">--index</span> <span class="pre">$x</span> <span class="pre">&amp;&amp;</span> <span class="pre">sleep</span> <span class="pre">2</span> <span class="pre">;</span> <span class="pre">}</span> <span class="pre">;</span> <span class="pre">done</span></code>.</li>
<li>To modify the number of calls/hour to simulate, edit/add
<code class="docutils literal"><span class="pre">count=&lt;number&gt;</span></code> to <code class="docutils literal"><span class="pre">/etc/clearwater/shared_config</span></code>, then run
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">/usr/share/clearwater/infrastructure/scripts/sip-stress</span></code> and
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">clearwater-sip-stress</span> <span class="pre">restart</span></code>.</li>
</ul>
<ol class="arabic simple" start="8">
<li>Create a Cacti server for monitoring the deployment, as described in
<a class="reference external" href="Cacti.md">this document</a>.</li>
<li>When you&#8217;ve finished, destroy your deployment with
<code class="docutils literal"><span class="pre">knife</span> <span class="pre">deployment</span> <span class="pre">delete</span> <span class="pre">-E</span> <span class="pre">ENVIRONMENT</span></code>.</li>
</ol>
</div>
<div class="section" id="manual-i-e-non-chef-stress-runs">
<h3>Manual (i.e. non-Chef) stress runs<a class="headerlink" href="#manual-i-e-non-chef-stress-runs" title="Permalink to this headline">¶</a></h3>
<p>SIP stress can also be run against a deployment that has been installed
manually (as per the <a class="reference external" href="Manual_Install.md">Manual Install
instructions</a>).</p>
<p>Firstly follow <a class="reference external" href="https://github.com/Metaswitch/crest/blob/dev/docs/Bulk-Provisioning%20Numbers.md">this
process</a>
to bulk provision subscribers. Work out how many stress nodes you want,
and create 30000 subscribers per SIPp node.</p>
<p>To create a new SIPp node, create a new virtual machine and bootstrap it
<a class="reference external" href="Manual_Install.md#configure-the-apt-software-sources">by configuring access to the Project Clearwater Debian
repository</a>.</p>
<p>Then set the following properties in /etc/clearwater/local_config:</p>
<ul class="simple">
<li>(required) local_ip - the local IP address of this node</li>
<li>(optional) node_idx - the node index (defaults to 1)</li>
</ul>
<p>Set the following properties in /etc/clearwater/shared_config:</p>
<ul class="simple">
<li>(required) home_domain - the home domain of the deployment under
test</li>
<li>(optional) bono_servers - a list of bono servers in this deployment</li>
<li>(optional) stress_target - the target host (defaults to the
:math:<a href="#id1"><span class="problematic" id="id2">`</span></a>node_idx-th entry in <a href="#id3"><span class="problematic" id="id4">`</span></a>bono_servers or, if there are no
:math:<a href="#id5"><span class="problematic" id="id6">`</span></a>bono_servers, defaults to <a href="#id7"><span class="problematic" id="id8">`</span></a>home_realm)</li>
<li>(optional) base - the base directory number (defaults to 2010000000)</li>
<li>(optional) count - the number of subscribers to run on this node
(must be even, defaults to 30000)</li>
</ul>
<p>Finally, run <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">clearwater-sip-stress</span></code> to install
the Debian package. Stress will start automatically after the package is
installed.</p>
</div>
<div class="section" id="configuring-udp-stress">
<h3>Configuring UDP Stress<a class="headerlink" href="#configuring-udp-stress" title="Permalink to this headline">¶</a></h3>
<p>SIPp supports UDP stress, and this works with Clearwater. To make a
stress test node run UDP stress (rather than the default of TCP)</p>
<ul class="simple">
<li>open /usr/share/clearwater/bin/sip-stress</li>
<li>find the line that begins &#8220;nice -n-20 /usr/share/clearwater/bin/sipp&#8221;</li>
<li>replace &#8220;-t tn&#8221; with &#8220;-t un&#8221;</li>
<li>save and exit</li>
<li>restart stress by typing &#8220;sudo service clearwater-sip-stress
restart&#8221;.</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Stress Testing</a><ul>
<li><a class="reference internal" href="#sip-stress-nodes">SIP Stress Nodes</a><ul>
<li><a class="reference internal" href="#what-they-do">What they do</a></li>
<li><a class="reference internal" href="#how-they-work">How they work</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-stress">Running Stress</a><ul>
<li><a class="reference internal" href="#using-chef">Using Chef</a></li>
<li><a class="reference internal" href="#manual-i-e-non-chef-stress-runs">Manual (i.e. non-Chef) stress runs</a></li>
<li><a class="reference internal" href="#configuring-udp-stress">Configuring UDP Stress</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Pull_request_process.html" title="previous chapter">Pull Request Process</a></li>
      <li>Next: <a href="Cacti.html" title="next chapter">Using Cacti with Clearwater</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Clearwater_stress_testing.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Metaswitch Networks.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="_sources/Clearwater_stress_testing.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>