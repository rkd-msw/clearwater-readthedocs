<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Debugging Clearwater with GDB and Valgrind &mdash; Project Clearwater 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Project Clearwater 1.0 documentation" href="index.html" />
    <link rel="next" title="Pull Request Process" href="Pull_request_process.html" />
    <link rel="prev" title="Ruby Coding Guidelines" href="Clearwater_Ruby_Coding_Guidelines.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="debugging-clearwater-with-gdb-and-valgrind">
<h1>Debugging Clearwater with GDB and Valgrind<a class="headerlink" href="#debugging-clearwater-with-gdb-and-valgrind" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="valgrind">
<h1>Valgrind<a class="headerlink" href="#valgrind" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://valgrind.org/">Valgrind</a> is a very powerful profiling and
debugging tool.</p>
<p>Before you run Bono or Sprout under valgrind, you may want to tweak
pjsip&#8217;s code slightly as indicated below, then rebuild and patch your
nodes.</p>
<ul class="simple">
<li>Valgrind&#8217;s memory access tracking hooks into malloc and free.
Unfortunately, pjsip uses its own memory management functions, and so
mallocs/frees relatively rarely. To disable this, modify
<code class="docutils literal"><span class="pre">pjlib/src/pj/pool_caching.c</span></code>&#8216;s <code class="docutils literal"><span class="pre">pj_caching_pool_init</span></code> function
to always set cp-&gt;max_capacity to 0.</li>
<li>Valgrind&#8217;s thread safety tool (helgrind) tracks the order in which
locks are taken, and reports on any lock cycles (which can in theory
cause deadlocks). One of these locks generates a lot of benign
results. To prevent these edit <code class="docutils literal"><span class="pre">pjsip\include\pjsip\sip_config.h</span></code>
and set the value of <code class="docutils literal"><span class="pre">PJSIP_SAFE_MODULE</span></code> to 0.</li>
<li>Valgrind&#8217;s thread safety tool also spots variables that are accessed
on mutliple threads without locking the locking necessary to prevent
race conditions. Pjsip&#8217;s memory pools maintain some statistics that
are not used by Clearwater, but that trip valgrind&#8217;s race condition
detection. To suppress this edit <code class="docutils literal"><span class="pre">pjlib/src/pj/pool_caching.c</span></code> and
remove the bodies of the <code class="docutils literal"><span class="pre">cpool_on_block_alloc</span></code> and
<code class="docutils literal"><span class="pre">cpool_on_block_free</span></code> (keeping only the bodies).</li>
</ul>
<p>To run Bono, Sprout or Homestead under valgrind (the example commands
assume you are running sprout), the easiest way is to:</p>
<ul class="simple">
<li>Find the command line you are using to run Sprout
(<code class="docutils literal"><span class="pre">ps</span> <span class="pre">-eaf</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">sprout</span></code>)</li>
<li>Make sure valgrind is installed on your system and you have the
appropriate debug packages installed
(<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">valgrind</span></code> and
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">sprout-dbg</span></code>)</li>
<li>Disable monitoring of sprout (<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">monit</span> <span class="pre">unmonitor</span> <span class="pre">-g</span> <span class="pre">sprout</span></code>)</li>
<li>Stop sprout (<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">sprout</span> <span class="pre">stop</span></code>)</li>
<li>Allow child processes to use more file descriptors, and become the
sprout user
(<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">-i;</span> <span class="pre">ulimit</span> <span class="pre">-Hn</span> <span class="pre">1000000;</span> <span class="pre">ulimit</span> <span class="pre">-Sn</span> <span class="pre">1000000;</span> <span class="pre">(sudo</span> <span class="pre">-u</span> <span class="pre">sprout</span> <span class="pre">bash);</span></code>)</li>
<li>Change to the <code class="docutils literal"><span class="pre">/etc/clearwater</span></code> directory</li>
<li>Set up the library path
(<code class="docutils literal"><span class="pre">export</span> <span class="pre">LD_LIBRARY_PATH=/usr/share/clearwater/sprout/lib:$LD_LIBRARY_PATH</span></code>)</li>
<li>Run the executable under valgrind, enabling the appropriate valgrind
options - for example, to use massif to monitor the Sprout heap
<code class="docutils literal"><span class="pre">valgrind</span> <span class="pre">--tools=massif</span> <span class="pre">--massif-out-file=/var/log/sprout/massif.out.%p</span> <span class="pre">/usr/share/clearwater/bin/sprout</span> <span class="pre">&lt;parameters&gt;</span></code>
(the &#8211;massif-out-file option is required to ensure the output is
written to a directory where the sprout user has write permission).
If any of Sprout parameters include a semi-colon, you must prefix
this with a backslash otherwise the bash interpreter will interpret
this as the end of the command.</li>
</ul>
<p>Valgrind will slow down the running of Bono, Sprout and Homestead by a
factor of 5-10. It will produce output when it detects invalid/illegal
memory access - often these turn out to be benign, but they&#8217;re rarely
spurious.</p>
</div>
<div class="section" id="gdb">
<h1>GDB<a class="headerlink" href="#gdb" title="Permalink to this headline">¶</a></h1>
<div class="section" id="installing">
<h2>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h2>
<p>To install gdb, simply type <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">gdb</span></code>. gdb is already
installed on build machines, but not on live nodes.</p>
<p>If you&#8217;re debugging on a live node, it&#8217;s also worth installing the
sprout or bono debug packages. When we build the standard (release)
versions, we strip all the symbols out and these are saved off
separately in the debug package. Note that you will still be running the
release code - the debug symbols will just be loaded by gdb when you
start it up. To install these packages, type
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">sprout-dbg</span></code> or
<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">bono-dbg</span></code>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Debugging Clearwater with GDB and Valgrind</a></li>
<li><a class="reference internal" href="#valgrind">Valgrind</a></li>
<li><a class="reference internal" href="#gdb">GDB</a><ul>
<li><a class="reference internal" href="#installing">Installing</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Clearwater_Ruby_Coding_Guidelines.html" title="previous chapter">Ruby Coding Guidelines</a></li>
      <li>Next: <a href="Pull_request_process.html" title="next chapter">Pull Request Process</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Debugging_Bono_Sprout_and_Homestead_with_GDB_and_Valgrind.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Metaswitch Networks.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="_sources/Debugging_Bono_Sprout_and_Homestead_with_GDB_and_Valgrind.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>